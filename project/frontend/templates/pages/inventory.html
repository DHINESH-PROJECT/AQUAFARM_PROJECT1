{% extends 'base.html' %}
{% load inventory_extras %}

{% block title %}Inventory Management - AquaCare{% endblock %}

{% block content %}
{% if messages %}
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}
{% endif %}

<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-warehouse me-3"></i>Inventory Management</h1>
                <p class="mb-0">Manage stock levels of fish, feed, and equipment</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" onclick="addInventoryItem()">
                    <i class="fas fa-plus me-2"></i>Add New Item
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-fish fa-3x text-primary mb-2"></i>
                    <h4 class="text-primary" id="fishStock">{{ fish_stock }}</h4>
                    <p class="text-muted">Fish Stock</p>
                    <small class="text-info">{{ category_stats.fish.count }} items</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-seedling fa-3x text-success mb-2"></i>
                    <h4 class="text-success" id="feedStock">{{ feed_stock }} kg</h4>
                    <p class="text-muted">Feed Stock</p>
                    <small class="text-info">{{ category_stats.feed.count }} items</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-tools fa-3x text-info mb-2"></i>
                    <h4 class="text-info" id="equipmentCount">{{ equipment_count }}</h4>
                    <p class="text-muted">Equipment</p>
                    <small class="text-info">{{ category_stats.equipment.total_quantity }} units</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-2"></i>
                    <h4 class="text-warning" id="lowStockAlerts">{{ low_stock_alerts }}</h4>
                    <p class="text-muted">Low Stock Alerts</p>
                    {% if low_stock_alerts > 0 %}
                        <small class="text-danger">Action Required!</small>
                    {% else %}
                        <small class="text-success">All Good!</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Statistics Row -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-dollar-sign fa-2x text-success mb-2"></i>
                    <h4 class="text-success">{{ total_value|currency }}</h4>
                    <p class="text-muted">Total Inventory Value</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                    <h4 class="text-warning">{{ pending_orders }}</h4>
                    <p class="text-muted">Pending Orders</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-shipping-fast fa-2x text-info mb-2"></i>
                    <h4 class="text-info">{{ shipped_orders }}</h4>
                    <p class="text-muted">Shipped Orders</p>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-boxes me-2"></i>Inventory Items</h3>
            <div class="d-flex gap-2">
                <select id="categoryFilter" class="form-select" style="width: 150px;" onchange="filterInventory()">
                    <option value="">All Categories</option>
                    <option value="fish">Fish</option>
                    <option value="feed">Feed</option>
                    <option value="equipment">Equipment</option>
                </select>
                <select id="statusFilter" class="form-select" style="width: 150px;" onchange="filterInventory()">
                    <option value="">All Status</option>
                    <option value="in-stock">In Stock</option>
                    <option value="low-stock">Low Stock</option>
                </select>
                <input type="text" id="searchInput" class="form-control" placeholder="Search items..." 
                       style="width: 200px;" onkeyup="filterInventory()">
                <button class="btn btn-outline-success" onclick="calculateTotals()">
                    <i class="fas fa-calculator me-1"></i>Calculate
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover" id="inventoryTable">
                <thead class="table-info">
                    <tr>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Unit</th>
                        <th>Price/Unit</th>
                        <th>Total Value</th>
                        <th>Min. Stock</th>
                        <th>Status</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in inventory_items %}
                    <tr data-category="{{ item.item_type }}" 
                        data-status="{% if item.quantity <= item.minimum_stock %}low-stock{% else %}in-stock{% endif %}"
                        data-item-name="{{ item.item_name|lower }}">
                        <td>
                            <div class="d-flex align-items-center">
                                {% if item.item_type == 'fish' %}
                                    <i class="fas fa-fish text-primary me-2" style="font-size: 24px;"></i>
                                {% elif item.item_type == 'feed' %}
                                    <i class="fas fa-seedling text-success me-2" style="font-size: 24px;"></i>
                                {% else %}
                                    <i class="fas fa-tools text-info me-2" style="font-size: 24px;"></i>
                                {% endif %}
                                <div>
                                    <strong>{{ item.item_name }}</strong>
                                    <br><small class="text-muted">ID: #{{ item.id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if item.item_type == 'fish' %}
                                <span class="badge bg-primary">Fish</span>
                            {% elif item.item_type == 'feed' %}
                                <span class="badge bg-success">Feed</span>
                            {% else %}
                                <span class="badge bg-info">Equipment</span>
                            {% endif %}
                        </td>
                        <td class="quantity-cell">
                            <strong>{{ item.quantity|format_quantity:item.unit }}</strong>
                            {% if item.quantity <= item.minimum_stock %}
                                <i class="fas fa-exclamation-triangle text-warning ms-1" title="Low Stock"></i>
                            {% endif %}
                        </td>
                        <td>{{ item.unit }}</td>
                        <td class="price-cell">{{ item.price_per_unit|currency }}</td>
                        <td class="total-value-cell">
                            <strong>{{ item.total_value|currency }}</strong>
                        </td>
                        <td>{{ item.minimum_stock }}</td>
                        <td>
                            {% if item.quantity <= item.minimum_stock %}
                                <span class="badge bg-{{ item|stock_status|status_class }}">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    {% if item.quantity == 0 %}Out of Stock{% else %}Low Stock{% endif %}
                                </span>
                                {% if item.quantity > 0 and item.quantity <= item.minimum_stock %}
                                    <br><small class="text-muted">{{ item.quantity|floatformat:0 }} remaining</small>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-{{ item|stock_status|status_class }}">
                                    <i class="fas fa-check me-1"></i>In Stock
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            {{ item.updated_at|date:"M d, Y" }}
                            <br><small class="text-muted">{{ item.updated_at|time:"H:i" }}</small>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="editItem('{{ item.id }}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-success" onclick="addStock('{{ item.id }}')" title="Add Stock">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="removeStock('{{ item.id }}')" title="Remove Stock">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('{{ item.id }}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="fas fa-box-open fa-3x mb-3"></i>
                            <br>No inventory items found. <a href="#" onclick="addInventoryItem()">Add your first item</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Low Stock Alerts Section -->
    {% if low_stock_items %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Low Stock Alerts</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for item in low_stock_items %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="alert alert-warning mb-0">
                                <strong>{{ item.item_name }}</strong>
                                <br>Current: {{ item.quantity }} {{ item.unit }}
                                <br>Minimum: {{ item.minimum_stock }} {{ item.unit }}
                                <br><small class="text-muted">Category: {{ item.get_item_type_display }}</small>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recent Orders Section -->
    {% if recent_orders %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Recent Orders Affecting Inventory</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Order #</th>
                                    <th>Item</th>
                                    <th>Customer</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order in recent_orders %}
                                <tr>
                                    <td>#{{ order.id }}</td>
                                    <td>{{ order.inventory_item.item_name }}</td>
                                    <td>{{ order.customer.username }}</td>
                                    <td>{{ order.quantity }} {{ order.inventory_item.unit }}</td>
                                    <td>
                                        <span class="badge bg-{% if order.status == 'pending' %}warning{% elif order.status == 'approved' %}info{% elif order.status == 'shipped' %}primary{% elif order.status == 'delivered' %}success{% else %}secondary{% endif %}">
                                            {{ order.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ order.order_date|date:"M d, Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Inventory Item Modal -->
<div class="modal fade" id="addInventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add Inventory Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addInventoryForm" method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Item Name</label>
                            <input type="text" class="form-control" name="item_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" name="item_type" required>
                                <option value="">Select Category</option>
                                <option value="fish">Fish</option>
                                <option value="feed">Feed</option>
                                <option value="equipment">Equipment</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" step="0.1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Unit</label>
                            <input type="text" class="form-control" name="unit" placeholder="e.g., kg, pieces, units" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price per Unit ($)</label>
                            <input type="number" class="form-control" name="price_per_unit" step="0.01" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Stock Level</label>
                        <input type="number" class="form-control" name="minimum_stock" step="0.1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-info" form="addInventoryForm">Save Item</button>
            </div>
        </div>
    </div>
</div>

<script>
function addInventoryItem() {
    const modal = new bootstrap.Modal(document.getElementById('addInventoryModal'));
    modal.show();
}

// Enhanced form validation
document.getElementById('addInventoryForm').addEventListener('submit', function(e) {
    const itemName = document.querySelector('input[name="item_name"]').value.trim();
    const quantity = parseFloat(document.querySelector('input[name="quantity"]').value);
    const pricePerUnit = parseFloat(document.querySelector('input[name="price_per_unit"]').value);
    const minimumStock = parseFloat(document.querySelector('input[name="minimum_stock"]').value);
    
    // Validation
    if (!itemName) {
        alert('Please enter an item name.');
        e.preventDefault();
        return;
    }
    
    if (isNaN(quantity) || quantity < 0) {
        alert('Please enter a valid quantity (must be 0 or greater).');
        e.preventDefault();
        return;
    }
    
    if (isNaN(pricePerUnit) || pricePerUnit < 0) {
        alert('Please enter a valid price per unit (must be 0 or greater).');
        e.preventDefault();
        return;
    }
    
    if (isNaN(minimumStock) || minimumStock < 0) {
        alert('Please enter a valid minimum stock level (must be 0 or greater).');
        e.preventDefault();
        return;
    }
    
    if (quantity < minimumStock) {
        if (!confirm('Current quantity is below minimum stock level. Continue anyway?')) {
            e.preventDefault();
            return;
        }
    }
});

// Filter inventory items
function filterInventory() {
    const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#inventoryTable tbody tr[data-category]');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const category = row.getAttribute('data-category').toLowerCase();
        const status = row.getAttribute('data-status').toLowerCase();
        const itemName = row.getAttribute('data-item-name').toLowerCase();
        
        let showRow = true;
        
        // Category filter
        if (categoryFilter && category !== categoryFilter) {
            showRow = false;
        }
        
        // Status filter
        if (statusFilter && status !== statusFilter) {
            showRow = false;
        }
        
        // Search filter
        if (searchInput && !itemName.includes(searchInput)) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // Update visible count
    const tableBody = document.querySelector('#inventoryTable tbody');
    let countMessage = tableBody.querySelector('.filter-count-message');
    
    if (countMessage) {
        countMessage.remove();
    }
    
    if (visibleCount === 0 && (categoryFilter || statusFilter || searchInput)) {
        const noResultsRow = document.createElement('tr');
        noResultsRow.className = 'filter-count-message';
        noResultsRow.innerHTML = `
            <td colspan="10" class="text-center text-muted py-4">
                <i class="fas fa-search fa-2x mb-3"></i>
                <br>No items found matching your filters.
                <br><button class="btn btn-link" onclick="clearFilters()">Clear Filters</button>
            </td>
        `;
        tableBody.appendChild(noResultsRow);
    }
    
    // Recalculate totals for visible items
    calculateTotals();
}

// Clear all filters
function clearFilters() {
    document.getElementById('categoryFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('searchInput').value = '';
    filterInventory();
}

// Calculate totals for visible items
function calculateTotals() {
    const visibleRows = document.querySelectorAll('#inventoryTable tbody tr[data-category]:not([style*="display: none"])');
    
    let totalValue = 0;
    let totalItems = 0;
    let lowStockCount = 0;
    
    const categoryTotals = {
        fish: { count: 0, quantity: 0, value: 0 },
        feed: { count: 0, quantity: 0, value: 0 },
        equipment: { count: 0, quantity: 0, value: 0 }
    };
    
    visibleRows.forEach(row => {
        const category = row.getAttribute('data-category');
        const status = row.getAttribute('data-status');
        const quantityCell = row.querySelector('.quantity-cell strong');
        const priceCell = row.querySelector('.price-cell');
        
        if (quantityCell && priceCell) {
            const quantity = parseFloat(quantityCell.textContent) || 0;
            const price = parseFloat(priceCell.textContent.replace('$', '')) || 0;
            const itemValue = quantity * price;
            
            totalValue += itemValue;
            totalItems++;
            
            if (status === 'low-stock') {
                lowStockCount++;
            }
            
            // Category totals
            if (categoryTotals[category]) {
                categoryTotals[category].count++;
                categoryTotals[category].quantity += quantity;
                categoryTotals[category].value += itemValue;
            }
        }
    });
    
    // Display calculated totals in a modal or alert
    const summary = `
Filtered Inventory Summary:
• Total Items: ${totalItems}
• Total Value: $${totalValue.toFixed(2)}
• Low Stock Items: ${lowStockCount}

Category Breakdown:
• Fish: ${categoryTotals.fish.count} items, ${categoryTotals.fish.quantity} units, $${categoryTotals.fish.value.toFixed(2)}
• Feed: ${categoryTotals.feed.count} items, ${categoryTotals.feed.quantity} kg, $${categoryTotals.feed.value.toFixed(2)}
• Equipment: ${categoryTotals.equipment.count} items, ${categoryTotals.equipment.quantity} units, $${categoryTotals.equipment.value.toFixed(2)}
    `;
    
    alert(summary);
}

// Inventory management functions
function editItem(itemId) {
    alert(`Edit functionality to be implemented for item ID: ${itemId}`);
    // TODO: Implement edit modal with pre-filled form
}

function addStock(itemId) {
    const quantity = prompt('Enter quantity to add:');
    if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
        // TODO: Implement AJAX call to update stock
        alert(`Add ${quantity} units to item ${itemId} - Feature to be implemented`);
        // location.reload(); // Temporary until AJAX is implemented
    } else if (quantity !== null) {
        alert('Please enter a valid positive number.');
    }
}

function removeStock(itemId) {
    const quantity = prompt('Enter quantity to remove:');
    if (quantity && !isNaN(quantity) && parseFloat(quantity) > 0) {
        // TODO: Implement AJAX call to update stock
        alert(`Remove ${quantity} units from item ${itemId} - Feature to be implemented`);
        // location.reload(); // Temporary until AJAX is implemented
    } else if (quantity !== null) {
        alert('Please enter a valid positive number.');
    }
}

function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this inventory item? This action cannot be undone.')) {
        // TODO: Implement AJAX call to delete item
        alert(`Delete item ${itemId} - Feature to be implemented`);
        // location.reload(); // Temporary until AJAX is implemented
    }
}

// Auto-refresh inventory data every 60 seconds
setInterval(function() {
    // TODO: Implement AJAX refresh without page reload
    console.log('Auto-refresh inventory data (to be implemented)');
}, 60000);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set current date/time in form
    const now = new Date();
    console.log('Inventory page loaded at:', now.toLocaleString());
    
    // Auto-calculate totals on load
    setTimeout(calculateTotals, 1000);
});
</script>
{% endblock %}