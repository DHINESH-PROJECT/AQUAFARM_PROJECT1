{% extends 'base.html' %}

{% block title %}Order Management - AquaCare{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1><i class="fas fa-clipboard-check me-3"></i>Order Management</h1>
                <p class="mb-0">View, approve, or reject farmer and agent orders with detailed analytics</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-primary" onclick="createOrder()">
                    <i class="fas fa-plus me-2"></i>Create New Order
                </button>
                <button class="btn btn-info ms-2" onclick="showDetailedStats()">
                    <i class="fas fa-chart-bar me-2"></i>Analytics
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <!-- Enhanced Statistics Dashboard -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <i class="fas fa-clock fa-3x text-warning mb-2"></i>
                    <h4 class="text-warning">{{ pending_orders }}</h4>
                    <p class="text-muted">Pending Orders</p>
                    <small class="text-info">{{ approval_rate }}% Approval Rate</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-success">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-3x text-success mb-2"></i>
                    <h4 class="text-success">{{ approved_orders }}</h4>
                    <p class="text-muted">Approved Orders</p>
                    <small class="text-info">Ready for Delivery</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-info">
                <div class="card-body">
                    <i class="fas fa-shipping-fast fa-3x text-info mb-2"></i>
                    <h4 class="text-info">{{ shipped_orders }}</h4>
                    <p class="text-muted">Shipped Orders</p>
                    <small class="text-info">In Transit</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <i class="fas fa-box-check fa-3x text-primary mb-2"></i>
                    <h4 class="text-primary">{{ delivered_orders }}</h4>
                    <p class="text-muted">Delivered</p>
                    <small class="text-info">{{ completion_rate }}% Complete</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <i class="fas fa-times-circle fa-3x text-danger mb-2"></i>
                    <h4 class="text-danger">{{ rejected_orders }}</h4>
                    <p class="text-muted">Rejected</p>
                    <small class="text-info">Quality Issues</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <i class="fas fa-dollar-sign fa-3x text-success mb-2"></i>
                    <h4 class="text-success">${{ total_revenue|floatformat:0 }}</h4>
                    <p class="text-muted">Total Revenue</p>
                    <small class="text-info">${{ average_order_value }} Avg</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Metrics Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-primary">{{ order_stats.total_orders }}</h5>
                    <small class="text-muted">Total Orders Placed</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-success">{{ total_quantity|floatformat:0 }}</h5>
                    <small class="text-muted">Total Items Ordered</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-info">${{ order_stats.max_order_value|floatformat:0 }}</h5>
                    <small class="text-muted">Highest Order Value</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="text-warning">${{ order_stats.min_order_value|floatformat:0 }}</h5>
                    <small class="text-muted">Lowest Order Value</small>
                </div>
            </div>
        </div>
    </div>

    <div class="table-container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-list me-2"></i>Order Details & Calculations</h3>
            <div class="d-flex gap-2">
                <select class="form-select" style="width: 150px;" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="rejected">Rejected</option>
                </select>
                <input type="text" class="form-control" placeholder="Search orders..." style="width: 200px;" id="searchFilter">
                <button class="btn btn-outline-primary" onclick="calculateTotals()">
                    <i class="fas fa-calculator me-1"></i>Recalculate
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover" id="ordersTable">
                <thead class="table-warning">
                    <tr>
                        <th>Order ID</th>
                        <th>Customer Details</th>
                        <th>Item & Pricing</th>
                        <th>Quantity Calc</th>
                        <th>Financial Details</th>
                        <th>Status & Progress</th>
                        <th>Date & Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr data-order-id="{{ order.id }}" data-status="{{ order.status }}" data-total="{{ order.total_price }}">
                        <td>
                            <strong>#ORD-{{ order.id|stringformat:"03d" }}</strong>
                            <br><small class="text-muted">Producer: {{ order.producer.username }}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if order.customer.role == 'farmer' %}
                                    <i class="fas fa-user-circle fa-2x text-success me-2"></i>
                                {% else %}
                                    <i class="fas fa-user-circle fa-2x text-primary me-2"></i>
                                {% endif %}
                                <div>
                                    <strong>{{ order.customer.username }}</strong>
                                    <br><small class="text-muted">{{ order.customer.role|title }}</small>
                                    {% if order.customer.phone %}
                                        <br><small class="text-info">{{ order.customer.phone }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="https://images.pexels.com/photos/1059905/pexels-photo-1059905.jpeg" 
                                     alt="{{ order.inventory_item.item_name }}" class="rounded me-2" 
                                     style="width: 40px; height: 40px; object-fit: cover;">
                                <div>
                                    <strong>{{ order.inventory_item.item_name }}</strong>
                                    <br><small class="text-muted">Type: {{ order.inventory_item.item_type|title }}</small>
                                    <br><small class="text-success">Rate: ${{ order.inventory_item.price_per_unit }}/{{ order.inventory_item.unit }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-center">
                                <h5 class="text-primary mb-1">{{ order.quantity|floatformat:1 }}</h5>
                                <small class="text-muted">{{ order.inventory_item.unit }}</small>
                                <br><small class="text-info">
                                    {% widthratio order.quantity order.inventory_item.quantity 100 %}% of stock
                                </small>
                                {% if order.quantity|floatformat:0|add:"0" > 50 %}
                                    <br><span class="badge bg-warning">Bulk Order</span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <div class="text-end">
                                <h5 class="text-success mb-1">${{ order.total_price|floatformat:2 }}</h5>
                                <small class="text-muted">
                                    Unit: ${{ order.inventory_item.price_per_unit }}
                                </small>
                                <br><small class="text-info">
                                    Calc: {{ order.quantity }} Ã— ${{ order.inventory_item.price_per_unit }}
                                </small>
                                {% if order.total_price > average_order_value %}
                                    <br><span class="badge bg-info">Above Average</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="order-status-cell">
                            <div class="text-center">
                                {% if order.status == 'pending' %}
                                    <span class="badge bg-warning mb-1">Pending</span>
                                    <br><small class="text-muted">Awaiting Review</small>
                                {% elif order.status == 'approved' %}
                                    <span class="badge bg-success mb-1">Approved</span>
                                    <br><small class="text-muted">Ready to Ship</small>
                                {% elif order.status == 'shipped' %}
                                    <span class="badge bg-info mb-1">Shipped</span>
                                    <br><small class="text-muted">In Transit</small>
                                {% elif order.status == 'delivered' %}
                                    <span class="badge bg-primary mb-1">Delivered</span>
                                    <br><small class="text-muted">Completed</small>
                                {% else %}
                                    <span class="badge bg-danger mb-1">Rejected</span>
                                    <br><small class="text-muted">Not Approved</small>
                                {% endif %}
                                <br><div class="progress mt-1" style="height: 4px;">
                                    {% if order.status == 'pending' %}
                                        <div class="progress-bar bg-warning" style="width: 25%"></div>
                                    {% elif order.status == 'approved' %}
                                        <div class="progress-bar bg-success" style="width: 50%"></div>
                                    {% elif order.status == 'shipped' %}
                                        <div class="progress-bar bg-info" style="width: 75%"></div>
                                    {% elif order.status == 'delivered' %}
                                        <div class="progress-bar bg-primary" style="width: 100%"></div>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-center">
                                <strong>{{ order.order_date|date:"M d, Y" }}</strong>
                                <br><small class="text-muted">{{ order.order_date|time:"H:i" }}</small>
                                <br><small class="text-info">
                                    {{ order.order_date|timesince }} ago
                                </small>
                            </div>
                        </td>
                        <td class="order-actions-cell">
                            {% if order.status == 'pending' %}
                                <button class="btn btn-sm btn-success me-1" onclick="approveOrder('{{ order.id }}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger me-1" onclick="rejectOrder('{{ order.id }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            {% elif order.status == 'approved' %}
                                <button class="btn btn-sm btn-info me-1" onclick="shipOrder('{{ order.id }}')">
                                    <i class="fas fa-shipping-fast"></i>
                                </button>
                            {% elif order.status == 'shipped' %}
                                <button class="btn btn-sm btn-primary me-1" onclick="trackOrder('{{ order.id }}')">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-primary" onclick="viewOrder('{{ order.id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-secondary">
                    <tr>
                        <th colspan="3">
                            <strong>TOTALS & CALCULATIONS</strong>
                        </th>
                        <th class="text-center">
                            <span id="totalQuantity">{{ total_quantity|floatformat:1 }}</span> units
                        </th>
                        <th class="text-end">
                            <span id="totalRevenue">${{ total_revenue|floatformat:2 }}</span>
                        </th>
                        <th class="text-center">
                            <span id="orderCount">{{ order_stats.total_orders }}</span> orders
                        </th>
                        <th class="text-center">
                            Avg: $<span id="avgOrder">{{ average_order_value }}</span>
                        </th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Detailed Analytics Section -->
    <div class="row mt-5" id="detailedStatsSection" style="display: none;">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5><i class="fas fa-chart-pie me-2"></i>Status Breakdown</h5>
                </div>
                <div class="card-body">
                    {% for status in status_breakdown %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-secondary">{{ status.status|title }}</span>
                        <span><strong>{{ status.count }}</strong> orders</span>
                        <span class="text-success">${{ status.total_value|floatformat:0 }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5><i class="fas fa-users me-2"></i>Top Customers</h5>
                </div>
                <div class="card-body">
                    {% for customer in customer_stats %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <strong>{{ customer.customer__username }}</strong>
                            <br><small class="text-muted">{{ customer.customer__role|title }}</small>
                        </div>
                        <div class="text-end">
                            <strong class="text-success">${{ customer.total_spent|floatformat:0 }}</strong>
                            <br><small class="text-muted">{{ customer.order_count }} orders</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3" id="itemStatsSection" style="display: none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="fas fa-box me-2"></i>Top Selling Items</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Orders</th>
                                    <th>Total Quantity</th>
                                    <th>Total Value</th>
                                    <th>Avg Price/Unit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in item_stats %}
                                <tr>
                                    <td><strong>{{ item.inventory_item__item_name }}</strong></td>
                                    <td>{{ item.order_count }}</td>
                                    <td>{{ item.total_quantity|floatformat:1 }} {{ item.inventory_item__unit }}</td>
                                    <td class="text-success">${{ item.total_value|floatformat:2 }}</td>
                                    <td>${{ item.avg_price_per_unit|floatformat:2 }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Order Modal -->
<div class="modal fade" id="createOrderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Create New Order</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createOrderForm" method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Item</label>
                            <select class="form-select" name="inventory_item_id" required>
                                <option value="">Choose an item</option>
                                {% for item in inventory_items %}
                                <option value="{{ item.id }}" data-price="{{ item.price_per_unit }}" data-unit="{{ item.unit }}">
                                    {{ item.item_name }} - ${{ item.price_per_unit }}/{{ item.unit }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" name="quantity" step="0.1" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Unit Price</label>
                            <input type="text" class="form-control" id="unitPrice" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Total Price</label>
                            <input type="text" class="form-control" id="totalPrice" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary" form="createOrderForm">Place Order</button>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Order Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Customer Information</h6>
                        <p><strong>Name:</strong> John Farmer</p>
                        <p><strong>Role:</strong> Farmer</p>
                        <p><strong>Email:</strong> john@example.com</p>
                        <p><strong>Phone:</strong> +1 555-0123</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Order Information</h6>
                        <p><strong>Order ID:</strong> #ORD-001</p>
                        <p><strong>Date:</strong> March 15, 2024</p>
                        <p><strong>Status:</strong> <span class="badge bg-warning">Pending</span></p>
                        <p><strong>Total:</strong> $225.00</p>
                    </div>
                </div>
                <hr>
                <h6>Items Ordered</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Atlantic Salmon Fingerlings</td>
                                <td>150 pieces</td>
                                <td>$1.50</td>
                                <td>$225.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type
                <button type="button" class="btn btn-success" onclick="approveOrder(1)">Approve Order</button>
                <button type="button" class="btn btn-danger" onclick="rejectOrder(1)">Reject Order</button>
            </div>
        </div>
    </div>
</div>

<script>
function createOrder() {
    const modal = new bootstrap.Modal(document.getElementById('createOrderModal'));
    modal.show();
}

function showDetailedStats() {
    const statsSection = document.getElementById('detailedStatsSection');
    const itemSection = document.getElementById('itemStatsSection');
    
    if (statsSection.style.display === 'none') {
        statsSection.style.display = 'block';
        itemSection.style.display = 'block';
        // Scroll to the stats section
        statsSection.scrollIntoView({ behavior: 'smooth' });
    } else {
        statsSection.style.display = 'none';
        itemSection.style.display = 'none';
    }
}

// Calculate total price when quantity or item changes
document.addEventListener('DOMContentLoaded', function() {
    const itemSelect = document.querySelector('select[name="inventory_item_id"]');
    const quantityInput = document.querySelector('input[name="quantity"]');
    const unitPriceInput = document.getElementById('unitPrice');
    const totalPriceInput = document.getElementById('totalPrice');
    
    function updatePrices() {
        const selectedOption = itemSelect.options[itemSelect.selectedIndex];
        const price = selectedOption.getAttribute('data-price');
        const unit = selectedOption.getAttribute('data-unit');
        const quantity = quantityInput.value;
        
        if (price && quantity) {
            unitPriceInput.value = `$${price}/${unit}`;
            totalPriceInput.value = `$${(parseFloat(price) * parseFloat(quantity)).toFixed(2)}`;
        } else {
            unitPriceInput.value = '';
            totalPriceInput.value = '';
        }
    }
    
    itemSelect.addEventListener('change', updatePrices);
    quantityInput.addEventListener('input', updatePrices);
    
    // Initialize filters
    initializeFilters();
});

function initializeFilters() {
    const statusFilter = document.getElementById('statusFilter');
    const searchFilter = document.getElementById('searchFilter');
    const table = document.getElementById('ordersTable');
    
    // Status filter
    statusFilter.addEventListener('change', function() {
        filterTable();
        calculateTotals();
    });
    
    // Search filter
    searchFilter.addEventListener('input', function() {
        filterTable();
        calculateTotals();
    });
}

function filterTable() {
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#ordersTable tbody tr');
    
    let visibleRows = 0;
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status').toLowerCase();
        const text = row.textContent.toLowerCase();
        
        const statusMatch = !statusFilter || status === statusFilter;
        const searchMatch = !searchFilter || text.includes(searchFilter);
        
        if (statusMatch && searchMatch) {
            row.style.display = '';
            visibleRows++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update visible count
    updateVisibleCount(visibleRows);
}

function updateVisibleCount(count) {
    // You can add a counter display here if needed
    console.log(`Showing ${count} orders`);
}

function calculateTotals() {
    const visibleRows = document.querySelectorAll('#ordersTable tbody tr[style=""], #ordersTable tbody tr:not([style])');
    let totalQuantity = 0;
    let totalRevenue = 0;
    let orderCount = 0;
    
    visibleRows.forEach(row => {
        if (row.style.display !== 'none') {
            const totalCell = row.getAttribute('data-total');
            const quantityCell = row.querySelector('td:nth-child(4) h5');
            
            if (totalCell) {
                totalRevenue += parseFloat(totalCell);
                orderCount++;
            }
            
            if (quantityCell) {
                totalQuantity += parseFloat(quantityCell.textContent);
            }
        }
    });
    
    // Update footer totals
    document.getElementById('totalQuantity').textContent = totalQuantity.toFixed(1);
    document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toFixed(2);
    document.getElementById('orderCount').textContent = orderCount;
    document.getElementById('avgOrder').textContent = orderCount > 0 ? (totalRevenue / orderCount).toFixed(2) : '0.00';
    
    // Show calculation animation
    animateCalculation();
}

function animateCalculation() {
    const elements = ['totalQuantity', 'totalRevenue', 'orderCount', 'avgOrder'];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        element.classList.add('calculation-update');
        setTimeout(() => {
            element.classList.remove('calculation-update');
        }, 1000);
    });
}

function approveOrder(orderId) {
    if (confirm('Are you sure you want to approve this order? This will deduct the quantity from inventory.')) {
        fetch(`/ajax/approve_order/${orderId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Update status cell in table row
                const row = document.querySelector(`tr[data-order-id='${orderId}']`);
                if (row) {
                    updateOrderStatus(row, data.new_status);
                }
                // Recalculate totals
                calculateTotals();
                // Refresh page after a short delay to show updated inventory
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showAlert(data.message, 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Network error. Please try again.', 'danger');
        });
    }
}

function updateOrderStatus(row, newStatus) {
    // Update data attribute
    row.setAttribute('data-status', newStatus);
    
    // Update status cell
    const statusCell = row.querySelector('.order-status-cell');
    let badgeClass, progressWidth, statusText;
    
    switch(newStatus) {
        case 'approved':
            badgeClass = 'bg-success';
            progressWidth = '50%';
            statusText = 'Approved';
            break;
        case 'shipped':
            badgeClass = 'bg-info';
            progressWidth = '75%';
            statusText = 'Shipped';
            break;
        case 'delivered':
            badgeClass = 'bg-primary';
            progressWidth = '100%';
            statusText = 'Delivered';
            break;
        default:
            badgeClass = 'bg-warning';
            progressWidth = '25%';
            statusText = 'Pending';
    }
    
    statusCell.innerHTML = `
        <div class="text-center">
            <span class="badge ${badgeClass} mb-1">${statusText}</span>
            <br><small class="text-muted">Status Updated</small>
            <br><div class="progress mt-1" style="height: 4px;">
                <div class="progress-bar ${badgeClass.replace('bg-', 'bg-')}" style="width: ${progressWidth}"></div>
            </div>
        </div>
    `;
    
    // Update actions
    updateActionButtons(row, newStatus);
}

function updateActionButtons(row, status) {
    const actionsCell = row.querySelector('.order-actions-cell');
    const orderId = row.getAttribute('data-order-id');
    
    let buttons = '';
    
    if (status === 'pending') {
        buttons = `
            <button class="btn btn-sm btn-success me-1" onclick="approveOrder('${orderId}')"><i class="fas fa-check"></i></button>
            <button class="btn btn-sm btn-danger me-1" onclick="rejectOrder('${orderId}')"><i class="fas fa-times"></i></button>
        `;
    } else if (status === 'approved') {
        buttons = `
            <button class="btn btn-sm btn-info me-1" onclick="shipOrder('${orderId}')"><i class="fas fa-shipping-fast"></i></button>
        `;
    } else if (status === 'shipped') {
        buttons = `
            <button class="btn btn-sm btn-primary me-1" onclick="trackOrder('${orderId}')"><i class="fas fa-map-marker-alt"></i></button>
        `;
    }
    
    buttons += `<button class="btn btn-sm btn-outline-primary" onclick="viewOrder('${orderId}')"><i class="fas fa-eye"></i></button>`;
    
    actionsCell.innerHTML = buttons;
}

function rejectOrder(orderId) {
    if (confirm('Are you sure you want to reject this order? This action cannot be easily undone.')) {
        fetch(`/ajax/reject_order/${orderId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'warning');
                const row = document.querySelector(`tr[data-order-id='${orderId}']`);
                if (row) {
                    updateOrderStatus(row, data.new_status);
                }
                calculateTotals();
                // Refresh page after a short delay to show updated inventory
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Network error. Please try again.', 'danger');
        });
    }
}

function shipOrder(orderId) {
    if (confirm('Mark this order as shipped? Customer will be notified.')) {
        fetch(`/ajax/ship_order/${orderId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'info');
                const row = document.querySelector(`tr[data-order-id='${orderId}']`);
                if (row) {
                    updateOrderStatus(row, data.new_status);
                }
                calculateTotals();
                // Refresh page after a short delay
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showAlert(data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Network error. Please try again.', 'danger');
        });
    }
}

function trackOrder(orderId) {
    showAlert('Opening tracking details...', 'info');
}

function viewOrder(orderId) {
    const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
    modal.show();
}

function getCSRFToken() {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') return value;
    }
    return '';
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container').firstElementChild;
    container.parentNode.insertBefore(alertDiv, container);
    
    // Auto dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

<style>
.calculation-update {
    animation: highlight 1s ease-in-out;
}

@keyframes highlight {
    0% { background-color: #fff3cd; }
    50% { background-color: #ffeaa7; }
    100% { background-color: transparent; }
}

.progress {
    background-color: #e9ecef;
}

.table-responsive {
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.card {
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.badge {
    font-size: 0.8em;
}
</style>
{% endblock %}